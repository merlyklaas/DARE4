---
title: "DARE4"
author: "Anwesha Guha, Merly Klaas, & Thuy Nguyen"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Define graphing colors
red_pink <- "#e64173"
turquoise <- "#20B2AA"
orange <- "#FFA500"
red <- "#fb6107"
blue <- "#3b3b9a"
green <- "#8bb174"
grey_light <- "grey70"
grey_mid <- "grey50"
grey_dark <- "grey20"
purple <- "#6A5ACD"
slate <- "#314f4f"

pacman::p_load(here, tidyverse, DT, ggplot2, xaringan, knitr, kableExtra, modelsummary, stargazer, xaringanthemer, gganimate, ggthemes, fixest, haven, arsenal, MatchIt, gtools, rio)

```

```{r}
dat <- import(here("data","dumont_umansky_ECLSK.dta"))
```

### A. Baseline differences (3 points)
*For the following tasks, give your best attempt at completing the analysis. If you are unable to conduct the programming or analysis, describe what you are attempting to do and what your results would mean.*

**A1** Present graphical and/or numerical evidence on whether teachers perceive students who are classified as ELs as having weaker language and mathematics skills in this data set. Describe the results of your assessment in 3-4 sentences. Should the evidence you have shared here be interpreted as a plausibly causal estimate of the effect of being classified as an EL student on teachers’ perceptions of students’ ability? In 1-2 sentences, answer why or why not.


```{r}
perception_diff <- dat %>% group_by(elprgm) %>% 
  summarise(n_students = n(), 
            mean_math=mean(tmathk), 
            se_math = sd(tmathk)/sqrt(n_students),
            mean_lang = mean(tlangk), 
            se_lang = sd(tlangk)/sqrt(n_students))

ggplot(perception_diff, 
       aes(x=as.factor(elprgm), y=mean_math, ymin=mean_math-se_math, ymax=mean_math+se_math)) + geom_col(fill = "darkgreen", alpha=0.4) + 
  geom_linerange() + 
  theme_pander(base_size = 16) +
  xlab("ELL Program Participation") + scale_y_continuous("Teacher perceptions of student's\n kinder math skills")
```

```{r}
ggplot(perception_diff,
       aes(x=as.factor(elprgm), y=mean_lang, ymin=mean_lang-se_lang, ymax=mean_lang+se_lang)) + geom_col(fill = "blue", alpha=0.4) + 
  geom_linerange() + 
  theme_pander(base_size = 16) +
  xlab("ELL Program Participation") + 
  scale_y_continuous("Teacher perceptions of student's kinder\n language skills")
```

**A2** Are there other ways in which students classified as EL learners are different from other students who live in homes where a language other than English is predominantly spoken, but are not classified as ELs? Present a table with quantitative information summarizing this fact and describe how this motivates your analytic strategy in Section B in 3-4 sentences.

```{r}
table_diff <- tableby(elprgm ~ hisp + ses + chrabsk + prelas + ebrs + female + rural, 
                 numeric.stats= c("meansd"), cat.stats=c("N", "countpct"), digits=2, data=dat)

summary(table_diff)

# students in program stat different from students who are not except for chronically absent and gender
# match based on these other covariates and to be able to parse the differences in perception
# otherwise students are inherently different and cannot be compared without matching based on ability 
```


### B. Replication and Extension (7 points)
*For the following tasks, give your best attempt at completing the analysis. If you are unable to conduct the programming or analysis, describe what you are attempting to do and what your results would mean.*


**B1.** Develop a formal model (an equation) that describes the probability that a student who lives in a home where a language other than English is predominantly spoken will be identified as an EL. Start with a basic model that defines EL-classification as a function of PreLAS score, EBRS score, Math/reading scores, SES, Rurality, Gender and Ethnicity (Hispanic/Latinx or not). From this starting probability, present a visual describing the region of common support for EL- and non-EL-classified students. Describe the substantive implications to your analytic strategy of this figure in 2-3 sentences.

```{r}
# 1. Fit logistic selection model estimating probability of participating in program, given covariates
pscores <- feglm(elprgm ~ prelas + ebrs + kread + kmath + ses + rural + female + hisp, family=c("logit"), data=dat)
summary(pscores)

# 2. Estimate fitted probability of selection into treatment for each individual
pscore_df <- data.frame(p_score = predict(pscores, type = "response"),
                        elprgm = dat$elprgm)
head(pscore_df)

# 3. Examine common support
ggplot(pscore_df, aes(p_score,fill = as.factor(elprgm), color = as.factor(elprgm))) + 
  geom_density(alpha=0.1) + 
  theme_pander(base_size = 12) + 
  xlab("Prop. of EL Program Participation")
```


```{r}
# 1. Generate matches
matched <- matchit(elprgm ~ prelas + ebrs + kread + kmath + ses + rural + female + hisp, method="nearest", replace=T, 
                   discard="both", data=dat)

# Create dataframe from matched data
df_match <- match.data(matched)

# Dimensions of dataframe
dim(df_match) #compared to 2166 x 16

## 2. Examine common support (post-match)
ggplot(df_match, aes(distance,fill = as.factor(elprgm), color = as.factor(elprgm))) + 
        geom_density(alpha=0.1) + 
        theme_pander(base_size = 16) + 
        xlab("Prop. of EL Program Participation")

## 3. Examine quality of matches, descriptively
summary(matched) # see slide 29 to interpret quality of matches
```

Extra exploration to estimate treatment effects:
```{r}
## 4. Once happy with matches, estimate treatment effect in matched sample
psmatch <- lm(elprgm ~ prelas + ebrs + kread + kmath + ses + rural + female + hisp, data=df_match, weights=weights)

summary(psmatch)

# Estimate confidence intervals
confint(psmatch)
```

**B2.** Construct a Coarsened Exact Matching (CEM) algorithm similar to Umansky and Dumont (see Class 8 Lecture) that relies on the following matching variables: (1) prelas, (2) ebrs, (3) kmath, (4) kread, (5) ses, (6) rural, (7) female and (8) hisp. Variables 1-5 are continuous. You should decide whether you will follow Umansky and Dumont’s choices for cutpoints or select other reasonable cutpoint values. Variables 6-8 are dichotomous and you should insist on exact matches for these categories. Write 1-2 paragraphs describing the identification strategy (remember this is different from your estimation strategy), its accompanying assumptions, your matching procedures and the resulting number of excluded sample members.

```{r}
matched <- matchit(elprgm ~ prelas + ebrs + ses + rural + female + hisp, method="nearest", replace=T, 
                   discard="both", data=dat)
# Create dataframe from matched data
df_match <- match.data(matched)
# Dimensions of dataframe
dim(df_match)
ggplot(df_match, aes(distance, fill = as.factor(elprgm), color = as.factor(elprgm))) + 
        geom_density(alpha=0.1) + 
        theme_pander(base_size = 16) + 
        xlab("Probability of elprgm")
## 3. Examine quality of matches, descriptively
summary(matched)
```

**B3.** Assess the quality of your matches by looking at the region of common support in your newly matched sample. Assess the quality of your matches by comparing baseline variable values in the treated and non- treated conditions. Provide a summary assessment of the quality of your matches, the extent to which you have accomplished balance, and the impact your matching has had on your sample as it relates to both variance and generalizability. Do you think you should try different matching criteria to achieve a better result? Why or why not (it is not necessary at this point to actually conduct multiple re-matching procedures, just assess whether they would be valuable)?
```{r}

```

**B4.** Using your newly matched sample, estimate the average treatment effect of EL classification on teachers’ perceptions of students’ math and language ability in your newly matched sample. If you decide to do B5, present these results and associated discussion along with the rest of your results in B5. If you do not, answer the rest of the prompt with just the CEM results. Present your CEM results and compare them to your results in A1 in a table and an accompanying write-up as you would report these in an academic paper in 1-2 paragraphs.

```{r}

```


**B5.** (OPTIONAL) Conduct a robustness check by estimating the causal effect of EL classification on teacher perceptions of student skills by using a propensity score matching approach (or another approach from the matching family if you choose). Share information on the quality of these matches and any additional assumptions associated with this approach. Present these results alongside your results in B4 in an accompanying table(s) and write-up as you would report these in an academic paper in 2-3 paragraphs.

```{r}

```

**B6.**Write a discussion paragraph in which you present the substantive conclusions (and limitations) of your results about the effects of EL classification on teacher perception of student skills in Kindergarten.

